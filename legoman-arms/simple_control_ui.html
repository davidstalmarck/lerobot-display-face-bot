<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            min-height: 100vh;
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .container {
            background: white;
            padding: 20px;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            flex: 1;
            overflow: hidden;
        }

        .left-panel, .right-panel {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .camera-section {
            margin-bottom: 20px;
        }

        .camera-section h2 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
        }

        #cameraFeed {
            width: 100%;
            border-radius: 12px;
            border: 3px solid #dee2e6;
            background: #f8f9fa;
        }

        .detections {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            min-height: 60px;
            font-size: 13px;
            color: #666;
        }

        .llm-description {
            margin-top: 10px;
            padding: 15px;
            background: linear-gradient(135deg, #e0f7fa 0%, #e1bee7 100%);
            border-radius: 8px;
            min-height: 50px;
            font-size: 14px;
            color: #333;
            font-weight: 500;
            line-height: 1.5;
            border-left: 4px solid #4facfe;
        }

        .detection-item {
            display: inline-block;
            margin: 3px;
            padding: 5px 10px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
            flex-shrink: 0;
        }

        .button-group {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        button {
            padding: 20px;
            font-size: 18px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        #recordBtn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        #recordBtn:hover:not(:disabled) {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
        }

        #playBtn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        #playBtn:hover:not(:disabled) {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
        }

        .speed-selector {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .speed-selector label {
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }

        .speed-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .speed-btn {
            padding: 10px;
            font-size: 14px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            color: #495057;
        }

        .speed-btn:hover {
            border-color: #4facfe;
            background: #e7f5ff;
            transform: translateY(-1px);
        }

        .speed-btn.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-color: #4facfe;
        }

        .arm-btn {
            padding: 10px;
            font-size: 14px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            color: #495057;
        }

        .arm-btn:hover {
            border-color: #fa8bff;
            background: #fef0ff;
            transform: translateY(-1px);
        }

        .arm-btn.active {
            background: linear-gradient(135deg, #fa8bff 0%, #2bd2ff 100%);
            color: white;
            border-color: #fa8bff;
        }

        .arm-status {
            margin-top: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 13px;
            color: #666;
        }

        .arm-status-item {
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #28a745;
        }

        .arm-status-item.disconnected {
            border-left-color: #dc3545;
        }

        .recording-name-group {
            margin-bottom: 20px;
        }

        .recording-name-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }

        .recording-name-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .recording-name-group input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .recordings-list {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .recordings-list label {
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }

        .recordings-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .recording-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            transition: all 0.2s;
        }

        .recording-item:hover {
            border-color: #4facfe;
            background: #e7f5ff;
        }

        .recording-item.selected {
            border-color: #4facfe;
            background: linear-gradient(135deg, #e7f5ff 0%, #f0f9ff 100%);
        }

        .recording-item-name {
            font-weight: 600;
            color: #333;
            cursor: pointer;
            flex: 1;
        }

        .recording-item-actions {
            display: flex;
            gap: 5px;
        }

        .recording-item-btn {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #dc3545;
            color: white;
            transition: all 0.2s;
        }

        .recording-item-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .no-recordings {
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
        }

        #stopBtn {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        #stopBtn:hover:not(:disabled) {
            background: linear-gradient(135deg, #fee140 0%, #fa709a 100%);
        }

        #relaxBtn {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        #relaxBtn:hover:not(:disabled) {
            background: linear-gradient(135deg, #fed6e3 0%, #a8edea 100%);
        }

        #armTrackBtn {
            background: linear-gradient(135deg, #fa8bff 0%, #2bd2ff 90%, #2bff88 100%);
            color: white;
        }

        #armTrackBtn:hover:not(:disabled) {
            background: linear-gradient(135deg, #2bff88 0%, #2bd2ff 10%, #fa8bff 100%);
        }

        #armTrackBtn.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            animation: pulse 1.5s infinite;
        }

        .status {
            text-align: center;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 14px;
            color: #666;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status.recording {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }

        .status.playing {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #17a2b8;
        }

        .status.relaxed {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #f5576c;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Robot Control</h1>

        <div class="main-content">
            <div class="left-panel">
                <div class="camera-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h2 style="margin: 0;">Camera Feed <span id="cameraIndex" style="font-size: 14px; color: #667eea; font-weight: normal;">(Camera 4)</span></h2>
                        <button id="switchCameraBtn" style="padding: 8px 16px; font-size: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üì∑ Switch Camera</button>
                    </div>
                    <img id="cameraFeed" src="http://localhost:5001/video_feed" alt="Camera feed">
                    <div class="llm-description" id="llmDescription">ü§ñ Analyzing...</div>
                    <div class="detections" id="detections">Detecting objects...</div>
                </div>
            </div>

            <div class="right-panel">
                <div class="recording-name-group">
                    <label for="recordingName">Recording Name:</label>
                    <input type="text" id="recordingName" placeholder="e.g., wave_hello" value="my_recording">
                </div>

                <div class="button-group">
                    <button id="checkArmsBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">üîç Check Arms Status</button>
                </div>

                <div id="armStatus" class="arm-status" style="display: none;"></div>

                <div class="speed-selector" style="margin-top: 0;">
                    <label>Arm Calibration (Movement Scale):</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <label style="font-size: 12px; color: #666;">üëà Left (0): <span id="arm0ScaleValue">0.8</span></label>
                            <input type="range" id="arm0Scale" min="0.5" max="1.5" step="0.05" value="0.8" style="width: 100%;">
                        </div>
                        <div style="flex: 1;">
                            <label style="font-size: 12px; color: #666;">üëâ Right (1): <span id="arm1ScaleValue">1.0</span></label>
                            <input type="range" id="arm1Scale" min="0.5" max="1.5" step="0.05" value="1.0" style="width: 100%;">
                        </div>
                    </div>
                </div>

                <div class="speed-selector" style="margin-top: 0;">
                    <label>Select Arm(s):</label>
                    <div class="speed-buttons">
                        <button class="arm-btn active" data-arm="both">ü§ñ Both</button>
                        <button class="arm-btn" data-arm="0">üëà Left (0)</button>
                        <button class="arm-btn" data-arm="1">üëâ Right (1)</button>
                        <button class="arm-btn" data-arm="swap" style="background: linear-gradient(135deg, #fa8bff 0%, #2bd2ff 100%); color: white;">üîÑ Swap</button>
                    </div>
                </div>

                <div class="button-group">
                    <button id="recordBtn">üî¥ Record</button>
                    <button id="playBtn">‚ñ∂Ô∏è Play</button>
                    <button id="stopBtn">‚èπÔ∏è Stop</button>
                    <button id="relaxBtn">üåä Relax</button>
                    <button id="armTrackBtn">ü§ñ Follow My Arm</button>
                </div>

                <div class="speed-selector">
                    <label>Playback Speed:</label>
                    <div class="speed-buttons">
                        <button class="speed-btn active" data-speed="1">1x</button>
                        <button class="speed-btn" data-speed="1.25">1.25x</button>
                        <button class="speed-btn" data-speed="1.5">1.5x</button>
                        <button class="speed-btn" data-speed="2">2x</button>
                    </div>
                </div>

                <div class="recordings-list">
                    <label>Saved Recordings:</label>
                    <div id="recordingsList" class="recordings-items">
                        <div class="no-recordings">No recordings yet</div>
                    </div>
                </div>

                <div class="status" id="status">Ready</div>
            </div>
        </div>
    </div>

    <script>
        const recordBtn = document.getElementById('recordBtn');
        const playBtn = document.getElementById('playBtn');
        const stopBtn = document.getElementById('stopBtn');
        const relaxBtn = document.getElementById('relaxBtn');
        const armTrackBtn = document.getElementById('armTrackBtn');
        const switchCameraBtn = document.getElementById('switchCameraBtn');
        const checkArmsBtn = document.getElementById('checkArmsBtn');
        const armStatus = document.getElementById('armStatus');
        const cameraFeed = document.getElementById('cameraFeed');
        const status = document.getElementById('status');
        const recordingNameInput = document.getElementById('recordingName');
        const recordingsList = document.getElementById('recordingsList');

        let isRecording = false;
        let isPlaying = false;
        let isArmTracking = false;
        let selectedSpeed = 1;
        let selectedArm = 'both';
        let selectedRecording = null;

        async function apiCall(endpoint, body = null) {
            try {
                const options = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                if (body) {
                    options.body = JSON.stringify(body);
                }
                const response = await fetch(`http://localhost:5001/${endpoint}`, options);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('API Error:', error);
                updateStatus('Connection error', 'error');
                return { success: false, message: error.message };
            }
        }

        async function loadRecordings() {
            const result = await fetch('http://localhost:5001/list_recordings');
            const data = await result.json();

            if (data.success && data.recordings.length > 0) {
                recordingsList.innerHTML = '';
                data.recordings.forEach(name => {
                    const item = document.createElement('div');
                    item.className = 'recording-item';
                    if (name === selectedRecording) {
                        item.classList.add('selected');
                    }

                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'recording-item-name';
                    nameSpan.textContent = name;
                    nameSpan.onclick = () => selectRecording(name);

                    const actions = document.createElement('div');
                    actions.className = 'recording-item-actions';

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'recording-item-btn';
                    deleteBtn.textContent = 'üóëÔ∏è';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteRecording(name);
                    };

                    actions.appendChild(deleteBtn);
                    item.appendChild(nameSpan);
                    item.appendChild(actions);
                    recordingsList.appendChild(item);
                });
            } else {
                recordingsList.innerHTML = '<div class="no-recordings">No recordings yet</div>';
            }
        }

        function selectRecording(name) {
            selectedRecording = name;
            recordingNameInput.value = name;
            loadRecordings();
        }

        async function deleteRecording(name) {
            if (confirm(`Delete recording "${name}"?`)) {
                const result = await apiCall('delete_recording', { name });
                if (result.success) {
                    updateStatus(`Deleted "${name}"`);
                    if (selectedRecording === name) {
                        selectedRecording = null;
                    }
                    loadRecordings();
                }
            }
        }

        function updateStatus(message, type = '') {
            status.textContent = message;
            status.className = 'status ' + type;

            if (type === 'recording') {
                const indicator = document.createElement('span');
                indicator.className = 'recording-indicator';
                status.insertBefore(indicator, status.firstChild);
            }
        }

        // Speed selector
        document.querySelectorAll('.speed-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedSpeed = parseFloat(btn.dataset.speed);
            });
        });

        // Arm selector
        document.querySelectorAll('.arm-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const arm = btn.dataset.arm;

                if (arm === 'swap') {
                    // Swap arms
                    const result = await apiCall('swap_arms');
                    if (result.success) {
                        updateStatus('Arms swapped! ACM0 ‚Üî ACM1', 'relaxed');
                    } else {
                        updateStatus(result.message || 'Failed to swap arms', 'error');
                    }
                } else {
                    // Select arm
                    document.querySelectorAll('.arm-btn').forEach(b => {
                        if (b.dataset.arm !== 'swap') {
                            b.classList.remove('active');
                        }
                    });
                    btn.classList.add('active');
                    selectedArm = arm;
                    updateStatus(`Selected: ${arm === 'both' ? 'Both arms' : arm === '0' ? 'Left arm (ACM0)' : 'Right arm (ACM1)'}`);
                }
            });
        });

        // Arm scale sliders
        const arm0ScaleSlider = document.getElementById('arm0Scale');
        const arm1ScaleSlider = document.getElementById('arm1Scale');
        const arm0ScaleValue = document.getElementById('arm0ScaleValue');
        const arm1ScaleValue = document.getElementById('arm1ScaleValue');

        // Load current scales from server
        async function loadArmScales() {
            try {
                const response = await fetch('http://localhost:5001/get_arm_scales');
                const data = await response.json();
                if (data.success) {
                    arm0ScaleSlider.value = data.arm0_scale;
                    arm1ScaleSlider.value = data.arm1_scale;
                    arm0ScaleValue.textContent = data.arm0_scale.toFixed(2);
                    arm1ScaleValue.textContent = data.arm1_scale.toFixed(2);
                }
            } catch (error) {
                console.error('Failed to load arm scales:', error);
            }
        }

        arm0ScaleSlider.addEventListener('input', async () => {
            const scale = parseFloat(arm0ScaleSlider.value);
            arm0ScaleValue.textContent = scale.toFixed(2);
        });

        arm0ScaleSlider.addEventListener('change', async () => {
            const scale = parseFloat(arm0ScaleSlider.value);
            const result = await apiCall('set_arm_scale', { arm: '0', scale });
            if (result.success) {
                updateStatus(result.message, 'relaxed');
            }
        });

        arm1ScaleSlider.addEventListener('input', async () => {
            const scale = parseFloat(arm1ScaleSlider.value);
            arm1ScaleValue.textContent = scale.toFixed(2);
        });

        arm1ScaleSlider.addEventListener('change', async () => {
            const scale = parseFloat(arm1ScaleSlider.value);
            const result = await apiCall('set_arm_scale', { arm: '1', scale });
            if (result.success) {
                updateStatus(result.message, 'relaxed');
            }
        });

        // Check arms status
        checkArmsBtn.addEventListener('click', async () => {
            checkArmsBtn.disabled = true;
            checkArmsBtn.textContent = '‚è≥ Checking...';

            try {
                const response = await fetch('http://localhost:5001/check_arms');
                const data = await response.json();

                if (data.success) {
                    let statusHtml = '<strong>Arm Status:</strong><br>';

                    // Arm 0 status
                    const arm0Class = data.arm0.connected ? '' : 'disconnected';
                    const arm0Icon = data.arm0.connected ? '‚úÖ' : '‚ùå';
                    statusHtml += `<div class="arm-status-item ${arm0Class}">`;
                    statusHtml += `${arm0Icon} <strong>Left Arm (ACM0)</strong> - ${data.arm0.port}<br>`;
                    if (data.arm0.connected) {
                        statusHtml += `Connected | Motors: ${Object.keys(data.arm0.positions).length}`;
                    } else {
                        statusHtml += `Disconnected${data.arm0.error ? ': ' + data.arm0.error : ''}`;
                    }
                    statusHtml += '</div>';

                    // Arm 1 status
                    const arm1Class = data.arm1.connected ? '' : 'disconnected';
                    const arm1Icon = data.arm1.connected ? '‚úÖ' : '‚ùå';
                    statusHtml += `<div class="arm-status-item ${arm1Class}">`;
                    statusHtml += `${arm1Icon} <strong>Right Arm (ACM1)</strong> - ${data.arm1.port}<br>`;
                    if (data.arm1.connected) {
                        statusHtml += `Connected | Motors: ${Object.keys(data.arm1.positions).length}`;
                    } else {
                        statusHtml += `Disconnected${data.arm1.error ? ': ' + data.arm1.error : ''}`;
                    }
                    statusHtml += '</div>';

                    armStatus.innerHTML = statusHtml;
                    armStatus.style.display = 'block';

                    updateStatus('Arm check complete', 'relaxed');
                } else {
                    updateStatus('Failed to check arms', 'error');
                }
            } catch (error) {
                console.error('Check arms error:', error);
                updateStatus('Connection error', 'error');
            }

            checkArmsBtn.disabled = false;
            checkArmsBtn.textContent = 'üîç Check Arms Status';
        });

        recordBtn.addEventListener('click', async () => {
            if (isRecording) {
                // Stop recording
                const result = await apiCall('stop_record');
                if (result.success) {
                    isRecording = false;
                    recordBtn.textContent = 'üî¥ Record';
                    updateStatus(result.message);
                    playBtn.disabled = false;
                    loadRecordings();
                }
            } else {
                // Start recording
                const name = recordingNameInput.value.trim();
                if (!name) {
                    updateStatus('Please enter a recording name', 'error');
                    return;
                }
                const result = await apiCall('record_arm', { name, arm: selectedArm });
                if (result.success) {
                    isRecording = true;
                    recordBtn.textContent = '‚è∏Ô∏è Stop Recording';
                    const armText = selectedArm === 'both' ? 'both arms' : selectedArm === '0' ? 'left arm' : 'right arm';
                    updateStatus(`Recording ${armText}... Move the robot freely`, 'recording');
                    playBtn.disabled = true;
                    stopBtn.disabled = false;
                }
            }
        });

        playBtn.addEventListener('click', async () => {
            const name = recordingNameInput.value.trim();
            if (!name) {
                updateStatus('Please select a recording', 'error');
                return;
            }
            const result = await apiCall('play_arm', { name, speed: selectedSpeed, arm: selectedArm });
            if (result.success) {
                isPlaying = true;
                const armText = selectedArm === 'both' ? 'both arms' : selectedArm === '0' ? 'left arm' : 'right arm';
                updateStatus(`Playing "${name}" on ${armText} at ${selectedSpeed}x speed...`, 'playing');
                playBtn.disabled = true;
                recordBtn.disabled = true;
                stopBtn.disabled = false;

                // Auto re-enable after playback (approximate)
                const duration = result.duration || 10;
                setTimeout(() => {
                    if (isPlaying) {
                        isPlaying = false;
                        playBtn.disabled = false;
                        recordBtn.disabled = false;
                        updateStatus('Playback complete');
                    }
                }, (duration / selectedSpeed) * 1000);
            } else {
                updateStatus(result.message || 'Recording not found', 'error');
            }
        });

        stopBtn.addEventListener('click', async () => {
            const result = await apiCall('stop');
            if (result.success) {
                isRecording = false;
                isPlaying = false;
                recordBtn.textContent = 'üî¥ Record';
                recordBtn.disabled = false;
                playBtn.disabled = false;
                updateStatus('Stopped');
            }
        });

        relaxBtn.addEventListener('click', async () => {
            const result = await apiCall('relax');
            if (result.success) {
                updateStatus('Motors relaxed - you can move the robot freely', 'relaxed');
            }
        });

        armTrackBtn.addEventListener('click', async () => {
            if (isArmTracking) {
                // Stop arm tracking
                const result = await apiCall('stop_arm_tracking');
                if (result.success) {
                    isArmTracking = false;
                    armTrackBtn.textContent = 'ü§ñ Follow My Arm';
                    armTrackBtn.classList.remove('active');
                    updateStatus('Arm tracking stopped');
                    recordBtn.disabled = false;
                    playBtn.disabled = false;
                }
            } else {
                // Start arm tracking
                const result = await apiCall('start_arm_tracking');
                if (result.success) {
                    isArmTracking = true;
                    armTrackBtn.textContent = 'üõë Stop Tracking';
                    armTrackBtn.classList.add('active');
                    updateStatus('Arm tracking active - Move your left arm!', 'playing');
                    recordBtn.disabled = true;
                    playBtn.disabled = true;
                } else {
                    updateStatus(result.message || 'Could not start arm tracking', 'error');
                }
            }
        });

        switchCameraBtn.addEventListener('click', async () => {
            switchCameraBtn.disabled = true;
            switchCameraBtn.textContent = '‚è≥ Switching...';

            const result = await apiCall('switch_camera');

            if (result.success) {
                updateStatus(`Switched to camera ${result.camera_index}`, 'relaxed');
                // Update camera index display
                document.getElementById('cameraIndex').textContent = `(Camera ${result.camera_index})`;
                // Force reload the video feed
                const timestamp = new Date().getTime();
                cameraFeed.src = `http://localhost:5001/video_feed?t=${timestamp}`;
            } else {
                updateStatus(result.message || 'Could not switch camera', 'error');
            }

            switchCameraBtn.disabled = false;
            switchCameraBtn.textContent = 'üì∑ Switch Camera';
        });

        // Update camera index on page load
        async function updateCameraIndex() {
            try {
                const response = await fetch('http://localhost:5001/status');
                const data = await response.json();
                if (data.success && data.camera_index !== undefined) {
                    document.getElementById('cameraIndex').textContent = `(Camera ${data.camera_index})`;
                }
            } catch (error) {
                console.error('Status error:', error);
            }
        }

        // Initial state
        stopBtn.disabled = false;
        playBtn.disabled = false;

        // Load recordings and settings on startup
        loadRecordings();
        updateCameraIndex();
        loadArmScales();

        // Poll for detections and LLM description
        async function updateDetections() {
            try {
                const response = await fetch('http://localhost:5001/detections');
                const data = await response.json();

                // Update LLM description
                const llmDiv = document.getElementById('llmDescription');
                if (data.success && data.description) {
                    llmDiv.textContent = 'ü§ñ ' + data.description;
                }

                // Update detections
                const detectionsDiv = document.getElementById('detections');
                if (data.success && data.detections && data.detections.length > 0) {
                    detectionsDiv.innerHTML = data.detections
                        .map(det => `<span class="detection-item">${det}</span>`)
                        .join('');
                } else {
                    detectionsDiv.textContent = 'No objects detected';
                }
            } catch (error) {
                console.error('Detection error:', error);
            }
        }

        // Update detections every 500ms
        setInterval(updateDetections, 500);
        updateDetections();
    </script>
</body>
</html>